# åœ–ç‰‡æ‰¹é‡å£“ç¸®èˆ‡è½‰æª”å·¥å…·

éæ­·ç›®éŒ„åŠæ‰€æœ‰å­ç›®éŒ„ï¼Œæ”¯æ´åœ–ç‰‡å£“ç¸®èˆ‡ WebP è½‰æª”ã€‚å·²æ”¹ç”¨ `uv` é€²è¡Œç’°å¢ƒèˆ‡ä¾è³´ç®¡ç†ã€‚

## å°ˆæ¡ˆåŠŸèƒ½

**compress-img (åœ–ç‰‡å£“ç¸®)**
- âœ… è‡ªè¨‚å£“ç¸®å“è³ª (1-100%)
- âœ… ä¸¦è¡Œè™•ç†åŠ é€Ÿæ‰¹é‡å£“ç¸®
- âœ… ä¿ç•™ EXIF è³‡è¨Š (GPSã€æ‹æ”æ™‚é–“ç­‰)
- âœ… è¦†è“‹/è·³éå·²å­˜åœ¨æª”æ¡ˆ
- âœ… æ™ºèƒ½åˆ¤æ–·ï¼šå£“ç¸®å¾Œè®Šå¤§å‰‡è‡ªå‹•è·³é
- âœ… æ”¯æ´æ ¼å¼ï¼šJPGã€JPEGã€PNGã€WebPã€BMPï¼ˆBMP æœƒè‡ªå‹•è·³éå› ç„¡å£“ç¸®æ•ˆæœï¼‰
- âœ… Dry-run é è¦½æ¨¡å¼
- âœ… ç¸½ç©ºé–“ç¯€çœçµ±è¨ˆ (åŸå§‹å¤§å° / å£“ç¸®å¾Œå¤§å° / ç¯€çœç™¾åˆ†æ¯”)
- âœ… æ”¯æ´æ·±åº¦æ§åˆ¶ (--max-depth)
- âœ… ProcessPoolExecutor å¤šè¡Œç¨‹å……åˆ†åˆ©ç”¨å¤šæ ¸ CPU
- âœ… **å…¨æ–°: Rich çµ‚ç«¯æ©Ÿè¦–è¦ºåŒ– (å‹•æ…‹é€²åº¦æ¢ã€ç²¾ç¾å ±è¡¨)**
- âœ… **å…¨æ–°: è‡ªè¨‚é ç«¯è¼¸å‡ºç›®éŒ„ `--out-dir` ä¸è½åœ°æ±¡æŸ“è³‡æ–™å¤¾**
- âœ… è‡ªå‹•ç•¥ééš±è—ç›®éŒ„ (`.git`, `.venv` ç­‰)

**images-to-webp (WebP è½‰æª”)**
- âœ… å°‡ JPG/PNG/BMP è½‰æ›ç‚º WebP æ ¼å¼
- âœ… **ä¿æŒåŸå§‹ç›®éŒ„çµæ§‹**ï¼šè½‰æª”å¾Œå­˜æ–¼ `webpimage` è³‡æ–™å¤¾ä¸­ï¼Œå­ç›®éŒ„çµæ§‹èˆ‡ä¾†æºç›¸åŒ
- âœ… è‡ªè¨‚ WebP å£“ç¸®å“è³ªæˆ–ç„¡æå£“ç¸® (--lossless)
- âœ… ä¿ç•™ EXIF è³‡è¨Š (--keep-exif)
- âœ… ä¸¦è¡Œè™•ç†åŠ é€Ÿ (ProcessPoolExecutor)
- âœ… æ”¯æ´è¦†è“‹å·²å­˜åœ¨æª”æ¡ˆ
- âœ… Dry-run é è¦½æ¨¡å¼
- âœ… ç¸½ç©ºé–“ç¯€çœçµ±è¨ˆ
- âœ… æ”¯æ´æ·±åº¦æ§åˆ¶ (--max-depth)
- âœ… **å…¨æ–°: Rich çµ‚ç«¯æ©Ÿè¦–è¦ºåŒ– (å‹•æ…‹é€²åº¦æ¢ã€ç²¾ç¾å ±è¡¨)**
- âœ… **å…¨æ–°: æ”¯æ´ `--out-dir`**
- âœ… è‡ªå‹•ç•¥ééš±è—ç›®éŒ„

## å®‰è£èˆ‡åŸ·è¡Œ

æœ¬å°ˆæ¡ˆä½¿ç”¨ [uv](https://github.com/astral-sh/uv) é€²è¡Œç®¡ç†ã€‚

### 1. å®‰è£ uv
è‹¥å°šæœªå®‰è£ uvï¼Œè«‹åƒè€ƒ [å®˜æ–¹æ–‡ä»¶](https://docs.astral.sh/uv/getting-started/installation/)ã€‚

### 2. åˆå§‹åŒ–ç’°å¢ƒ
```bash
uv sync
```

### 3. åŸ·è¡Œç¨‹å¼

**åœ–ç‰‡å£“ç¸® (åŸåœ°å£“ç¸®/å¦å­˜æ–°æª”)**
```bash
uv run compress-img "D:\Photos"
```

**åœ–ç‰‡è½‰ WebP (è¼¸å‡ºè‡³ webpimage)**
```bash
uv run images-to-webp "D:\Photos"
```

## ä½¿ç”¨æ–¹å¼

### compress-img (åœ–ç‰‡å£“ç¸®)

```bash
uv run compress-img <ç›®éŒ„è·¯å¾‘> [é¸é …]
```

| åƒæ•¸ | èªªæ˜ | é è¨­å€¼ |
|------|------|--------|
| `-O, --out-dir` | è‡ªè¨‚è¼¸å‡ºç›®éŒ„ (ç•™ç©ºå‰‡åœ¨åŸåœ°å»ºç«‹) | (ç„¡) |
| `-q, --quality` | å£“ç¸®å“è³ª 1-100 | 70 |
| `-o, --overwrite` | è¦†è“‹å·²å­˜åœ¨çš„å£“ç¸®æª” | å¦ |
| `-e, --keep-exif` | ä¿ç•™ EXIF è³‡è¨Š | å¦ |
| `-w, --workers` | Process æ•¸é‡ (ä¸¦è¡Œ) | 4 |
| `-n, --dry-run` | é è¦½æ¨¡å¼ï¼šåƒ…åˆ—å‡ºå¾…è™•ç†æª”æ¡ˆ | å¦ |
| `-d, --max-depth`| æœ€å¤§éè¿´æ·±åº¦ (0=ä¸é€²å…¥å­ç›®éŒ„) | ç„¡é™ |

### images-to-webp (WebP è½‰æª”)

```bash
uv run images-to-webp <ç›®éŒ„è·¯å¾‘> [é¸é …]
```

| åƒæ•¸ | èªªæ˜ | é è¨­å€¼ |
|------|------|--------|
| `-O, --out-dir` | è‡ªè¨‚è¼¸å‡ºç›®éŒ„ (ç•™ç©ºå‰‡å»ºç«‹ webpimage å¤¾) | (ç„¡) |
| `-q, --quality` | WebP å£“ç¸®å“è³ª 1-100 | 80 |
| `-o, --overwrite` | è¦†è“‹å·²å­˜åœ¨çš„ WebP æª”æ¡ˆ | å¦ |
| `-l, --lossless` | ä½¿ç”¨ç„¡æå£“ç¸® | å¦ |
| `-e, --keep-exif` | ä¿ç•™ EXIF è³‡è¨Š | å¦ |
| `-w, --workers` | Process æ•¸é‡ (ä¸¦è¡Œ) | 4 |
| `-n, --dry-run` | é è¦½æ¨¡å¼ï¼šåƒ…åˆ—å‡ºå¾…è™•ç†æª”æ¡ˆ | å¦ |
| `-d, --max-depth`| æœ€å¤§éè¿´æ·±åº¦ | ç„¡é™ |

### ç¯„ä¾‹

```bash
# [å£“ç¸®] ä¸è½åœ°ï¼šå°‡ D:\Photos ç›®éŒ„çš„çµæ§‹è·Ÿæª”æ¡ˆï¼Œå£“ç¸®å­˜å‡ºè‡³ E:\Backupï¼Œä¸”å“è³ª 50%
uv run compress-img "D:\Photos" -O "E:\Backup" -q 50

# [å£“ç¸®] é è¦½æ¨¡å¼ï¼Œä¸å¯¦éš›å£“ç¸®
uv run compress-img "D:\Photos" --dry-run

# [è½‰æª”] å°‡ D:\Photos ä¸‹æ‰€æœ‰åœ–ç‰‡è½‰ç‚º WebPï¼Œå­˜å…¥ D:\Photos\webpimageï¼Œç„¡æå£“ç¸®ä¸¦ä¿ç•™ EXIF
uv run images-to-webp "D:\Photos" --lossless --keep-exif

# [è½‰æª”] é è¦½æ¨¡å¼
uv run images-to-webp "D:\Photos" --dry-run

# äº’å‹•æ¨¡å¼ (æœƒæç¤ºè¼¸å…¥ç›®éŒ„)
uv run compress-img
uv run images-to-webp
```

### è¼¸å‡ºç¯„ä¾‹

```
â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ åœ–ç‰‡å£“ç¸®å·¥å…· v5.0 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚ ğŸ“‚ ç›®æ¨™æ­¸æª”ä¾†æº: D:\Photos                          â”‚
â”‚ ğŸ“ æœ€å¾Œå­˜æ”¾ä½ç½®: [åŸåœ°æ”¾ç½®ä¸¦åŠ å¾Œç¶´å­—]                 â”‚
â”‚ âš™ï¸   å£“ç¸®å“è³ª: 70%                                   â”‚
â”‚ ğŸš€ ä¸¦ç™¼æ•¸é‡: 4                                       â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
æ‰¾åˆ° 50 å¼µåœ–ç‰‡ï¼Œé–‹å§‹é€²è¡Œ å£“ç¸®...

â ‹ å£“ç¸®ä¸­... â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•¸ 100% 0:00:03

â•­â”€ ğŸ“Š åŸ·è¡Œçµæœåˆ†æ â”€â”¬â”€â”€â”€â”€â”€â”€â•®
â”‚ ç‹€æ…‹              â”‚ æ•¸é‡ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤
â”‚ å£“ç¸®ç²¾ç°¡æˆåŠŸ      â”‚   48 â”‚
â”‚ è·³é (å·²å‚™ä»½/éš±è—)â”‚    1 â”‚
â”‚ è·³é (ç„¡æ•ˆå£“ç¸®)   â”‚    1 â”‚
â”‚ å¤±æ•—              â”‚    0 â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â•¯
â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚ ğŸ’¾ ç£ç¢Ÿç©ºé–“è®ŠåŒ–   â”‚           å®¹é‡å¤§å° â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åŸå§‹ç¸½å¤§å°      â”‚          150.2 MB  â”‚
â”‚ å£“ç¸®å¾Œç¸½å¤§å°    â”‚           82.3 MB  â”‚
â”‚ å¯¦éš›ç¯€çœç©ºé–“    â”‚     67.9 MB (45.2%)â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
```

## å°ˆæ¡ˆçµæ§‹
- `utils.py`: å…±ç”¨æ¨¡çµ„ (FileResultã€ä¸¦è¡Œç®¡ç·šã€çµ±è¨ˆå½™æ•´ã€CLI å…±ç”¨å…ƒä»¶)
- `compress_images.py`: åœ–ç‰‡å£“ç¸®é‚è¼¯
- `images_to_webp.py`: WebP è½‰æª”èˆ‡ç›®éŒ„é¡åƒé‚è¼¯
- `pyproject.toml`: å°ˆæ¡ˆè¨­å®šèˆ‡ä¾è³´ç®¡ç† (uv)
- `uv.lock`: ä¾è³´é–å®šæª”

## æ¶æ§‹è¨­è¨ˆ

```
utils.py
â”œâ”€â”€ FileResult (dataclass)     â€” å–®æª”è™•ç†çµæœï¼Œå–ä»£å…¨åŸŸ mutable state
â”œâ”€â”€ ProcessingSummary           â€” æ‰¹æ¬¡çµ±è¨ˆæ‘˜è¦
â”œâ”€â”€ collect_files()             â€” éè¿´æ”¶é›†åœ–ç‰‡æª”æ¡ˆ
â”œâ”€â”€ run_pipeline()              â€” ä¸¦è¡Œè™•ç†ç®¡ç·š (ThreadPoolExecutor)
â”œâ”€â”€ print_summary()             â€” çµæœ/ç©ºé–“çµ±è¨ˆè¼¸å‡º
â”œâ”€â”€ create_base_parser()        â€” å…±ç”¨ argparse å»ºæ§‹
â”œâ”€â”€ resolve_directory()         â€” ç›®éŒ„è§£æ (å«äº’å‹•æ¨¡å¼)
â””â”€â”€ validate_quality()          â€” å“è³ªåƒæ•¸é©—è­‰

compress_images.py
â”œâ”€â”€ compress_image()            â€” å–®å¼µå£“ç¸® Worker (å›å‚³ FileResult)
â””â”€â”€ main()                      â€” CLI å…¥å£ (partial ç¶å®š â†’ run_pipeline)

images_to_webp.py
â”œâ”€â”€ convert_to_webp()           â€” å–®å¼µè½‰æª” Worker (å›å‚³ FileResult)
â””â”€â”€ main()                      â€” CLI å…¥å£ (partial ç¶å®š â†’ run_pipeline)
```

## License

MIT

## Authors
- [linuxfab](https://github.com/linuxfab)
- Last Update: 2026-02-22
